# Детальное описание пользовательского интерфейса PanelFlow

## 1. Философия интерфейса

Интерфейс PanelFlow спроектирован вокруг трех ключевых принципов: **контекст**, **предсказуемость** и **управление с клавиатуры**.

1. **Сохранение контекста**: Пользователь всегда должен видеть свой путь. Горизонтальная навигация по колонкам показывает последовательность шагов (`A → B → C`). Новая **вертикальная (стековая) навигация** позволяет исследовать параллельные ветви (`A → B`, `A → C`, `A → D`) без потери контекста родителя.
    
2. **Предсказуемость навигации**: Действия пользователя должны приводить к ожидаемым и логичным результатам. Появление новой панели справа (горизонтально) или "поверх" текущей (вертикально) является фундаментальным правилом.
    
3. **Приоритет клавиатуры (Keyboard-First)**: Весь интерфейс должен быть на 100% управляемым с клавиатуры. Мышь является вспомогательным, но не обязательным инструментом.
    

## 2. Визуальная структура основного окна

### 2.1. Заголовок (Header)

- **Расположение**: Одна строка в верхней части экрана.
    
- **Содержимое**: Разделено на две части.
    
    - **Индикатор скрытых панелей (слева)**: Отображает стрелку и число (`◀ 2`), если в текущем пути навигации есть панели, которые не помещаются на экране и находятся "левее" видимой области. Если все панели пути видны, этот индикатор скрыт.
        
    - **Хлебные крошки (справа)**: Отображает заголовки (`title`) всех видимых на данный момент панелей, разделенные слешем. Например: `Главная / Выбор диска / Список файлов`.
        

### 2.2. Область панелей

- **Макет**: Пространство под заголовком разделено на **три вертикальных слота** одинаковой ширины. Эти слоты являются постоянными контейнерами.
    
- **Панель**: Каждая панель представляет собой отдельный виджет, который отображается в одном из слотов. Она имеет следующую структуру:
    
    - **Заголовок (`title`)**: Отображается вверху панели.
        
    - **Описание (`description`)**: Опциональный текст под заголовком.
        
    - **Область контента**: Прокручиваемая область, содержащая виджеты (`TextInput`, `Button` и т.д.).
        
- **Индикация фокуса**:
    
    - **Активная панель**: Панель, которая в данный момент имеет фокус, визуально выделяется. Например, ее рамка может быть другого цвета или толщины. Только в активной панели можно взаимодействовать с виджетами.
        
    - **Активный виджет**: Внутри активной панели виджет, который сейчас в фокусе, также выделяется (например, рамкой или инвертированием цветов).
        
- **Индикация стека**: Если в стеке под активной панелью есть другие панели, под ней виден "край" заголовка следующей панели. Аналогично, если над активной панелью есть панели, над ней виден "край" заголовка предыдущей. Это создает ощущение картотеки.
    

## 3. Управление и горячие клавиши

### `Ctrl + →` / `Ctrl + ←`

- **Действие**: Перемещение фокуса между **видимыми панелями**.
    
- **Логика**: `Ctrl + →` перемещает фокус на панель справа, `Ctrl + ←` — на панель слева. Действие циклично в пределах видимых панелей. Это не изменяет дерево состояний, только меняет `active_node` в ядре.
    

### `Tab` / `Shift + Tab`

- **Действие**: Перемещение фокуса между **виджетами внутри активной панели**.
    
- **Логика**: `Tab` перемещает фокус на следующий виджет вниз, `Shift + Tab` — на предыдущий. Фокус циклически перемещается по всем интерактивным виджетам панели. Если виджет находится за пределами видимой области, панель должна автоматически прокрутиться к нему.
    

### `↑` / `↓` (Клавиши со стрелками)

- **Действие**: Контекстно-зависимая навигация внутри виджета.
    
- **Логика**:
    
    - В виджете-списке (`AbstractOptionSelect`): перемещение выделения между элементами списка.
        
    - В текстовом поле (`AbstractTextInput`, `AbstractTextArea`): перемещение курсора по тексту.
        

### `Enter`

- **Действие**: Основная клавиша подтверждения или действия.
    
- **Логика**:
    
    - На `Button` или `PanelLink`: инициирует связанное с ним действие (вызывает `WidgetSubmittedEvent`).
        
    - На `TextInput`: подтверждает ввод и отправляет значение (`WidgetSubmittedEvent`).
        
    - На `OptionSelect`: подтверждает выбор выделенного элемента (`WidgetSubmittedEvent`).
        

### `←` (Стрелка влево) или `Backspace`

- **Действие**: Закрыть текущую панель (вернуться назад).
    
- **Логика**: Это критически важное навигационное действие.
    
    1. Ядру отправляется событие `BackNavigationEvent`.
        
    2. Ядро находит текущий `active_node` и его родителя (`parent`).
        
    3. Текущий узел и все его дочерние узлы удаляются из дерева состояний.
        
    4. Фокус (`active_node`) перемещается на родительский узел.
        
    5. Ядро публикует `StateChangedEvent`, и рендерер перерисовывает интерфейс. Визуально это выглядит так, будто правая панель исчезла, а фокус переместился на панель, которая теперь стала крайней справа.
        

### `Ctrl + ↑` / `Ctrl + ↓`

- **Действие**: Перемещение по **стеку панелей внутри одной колонки**.
    
- **Логика**: `Ctrl + ↓` скрывает текущую активную панель `B` (перемещая ее "вверх" в стопке) и делает активной панель `C`, которая была под ней. `Ctrl + ↑` выполняет обратное действие. Контекст панелей сохраняется.
    

## 4. Жизненный цикл панелей

### Появление и замена

- Новая панель всегда появляется **справа от своей родительской панели**.
    
- Это происходит, когда пользователь выполняет навигационное действие (например, нажимает `Enter` на `PanelLink`).
    
- Если на экране уже есть 3 панели, и появляется четвертая, крайняя левая панель "уходит" за пределы экрана. Она не уничтожается, а просто перестает быть видимой. В заголовке появляется или обновляется индикатор `◀`.
    
- Фокус ввода **автоматически** переходит на только что созданную, крайнюю правую панель.
    
- Если виджет в `Панели 1` создает дочернюю панель `A`, она появляется в колонке справа.
    
- Если другой виджет в `Панели 1` создает панель `B`, она появляется **на месте панели `A`**, а `A` уходит в стек "над" `B`.
    
- **Повторное создание**: Если пользователь снова нажимает на виджет, создающий панель `B`, **старая ветка `B` со всеми ее потомками уничтожается**, и на ее месте создается новая, чистая панель `B`.
    

### Переход фокуса

- Фокус может быть передан между видимыми панелями с помощью `Ctrl + ←/→`. Это не меняет структуру панелей.
    
- При создании новой панели фокус всегда переходит на нее.
    
- При закрытии панели (`←`) фокус всегда переходит на ее родителя (новую крайнюю правую панель).